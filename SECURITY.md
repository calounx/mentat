# Security Policy

## Supported Versions

We release patches for security vulnerabilities in the following versions:

### Observability Stack

| Version | Supported          |
| ------- | ------------------ |
| 4.x.x   | :white_check_mark: |
| 3.0.x   | :white_check_mark: |
| 2.x.x   | :x:                |
| < 2.0   | :x:                |

### CHOM

| Version | Supported          |
| ------- | ------------------ |
| 1.x.x   | :white_check_mark: |
| < 1.0   | :x:                |

## Reporting a Vulnerability

**PLEASE DO NOT REPORT SECURITY VULNERABILITIES THROUGH PUBLIC GITHUB ISSUES.**

We take security seriously. If you discover a security vulnerability, please follow responsible disclosure practices.

### How to Report

1. **GitHub Security Advisory (Recommended)**
   - Go to: https://github.com/calounx/mentat/security/advisories/new
   - This ensures private disclosure until a fix is ready

2. **Alternative: GitHub Issue (Non-Critical)**
   - For lower-severity issues, open a GitHub issue
   - https://github.com/calounx/mentat/issues

### What to Include

Please include as much information as possible:

```
Subject: SECURITY: [Brief Description]

Project: [Observability Stack / CHOM / Both]

Vulnerability Details:
- Component affected: [e.g., setup-observability.sh, SiteController.php]
- Type of vulnerability: [e.g., command injection, SQL injection, XSS]
- Attack vector: [How can it be exploited?]
- Impact: [What can an attacker achieve?]
- Affected versions: [Which versions are vulnerable?]

Reproduction Steps:
1. [Step 1]
2. [Step 2]
3. [Step 3]

Proof of Concept:
[Code or commands to demonstrate the vulnerability]

Suggested Fix:
[If you have ideas for fixing it]

Additional Context:
[Any other relevant information]
```

### What to Expect

1. **Acknowledgment**: Within 24-48 hours
2. **Initial Assessment**: Within 3-5 business days
3. **Status Updates**: Weekly until resolved
4. **Resolution**: Depends on severity
   - Critical: 7 days
   - High: 14 days
   - Medium: 30 days
   - Low: 90 days

### Our Commitment

- We will acknowledge your report promptly
- We will investigate and validate the issue
- We will keep you informed of our progress
- We will notify you when the issue is fixed
- We will publicly acknowledge your contribution (if you wish)

---

## Security Considerations

### For Observability Stack

#### Secrets Management

**DO NOT commit secrets to the repository:**

- API keys
- Passwords
- Private keys
- Certificates
- Tokens
- Domain names (in config files)
- Email addresses (in config files)

**Use the built-in secrets management:**

```bash
# Store secrets securely
cd observability-stack
./scripts/init-secrets.sh

# Secrets location
/opt/observability-stack/secrets/

# Secrets are encrypted using systemd credentials
```

#### Network Security

- Grafana, Prometheus, and Loki should be behind authentication
- Use SSL/TLS for all external endpoints
- Configure firewall rules appropriately
- Don't expose monitoring ports to the public internet

#### Access Control

- Use strong passwords for Grafana admin
- Limit SSH access to monitoring servers
- Use key-based authentication, not passwords
- Implement least-privilege principles

### For CHOM

#### Environment Variables

**NEVER commit `.env` files with real credentials:**

```bash
# Bad - DO NOT DO THIS
git add .env

# Good - Only commit examples
git add .env.example
```

**Required security configurations:**

```env
# Use strong APP_KEY (generated by php artisan key:generate)
APP_KEY=base64:...

# Use environment-appropriate settings
APP_DEBUG=false  # In production
APP_ENV=production

# Strong database credentials
DB_PASSWORD=strong_random_password_here

# Stripe webhooks require secret validation
STRIPE_WEBHOOK_SECRET=whsec_...

# Use secure session drivers in production
SESSION_DRIVER=database  # or redis
```

#### API Security

- All API endpoints use Laravel Sanctum for authentication
- Rate limiting is enabled (see routes/api.php)
- CSRF protection is enabled for web routes
- Input validation on all endpoints

#### Tenant Isolation

- Prometheus/Loki queries are scoped by tenant ID
- VPS operations require proper authorization
- Site backups are tenant-isolated
- Cross-tenant access is prevented by policies

#### SSH Key Management

```bash
# Store SSH keys securely
chmod 600 storage/app/ssh/chom_deploy_key
chown www-data:www-data storage/app/ssh/chom_deploy_key

# Never commit SSH keys
# They are in .gitignore: chom/storage/*.key
```

### General Best Practices

1. **Keep Dependencies Updated**
   ```bash
   # Observability stack
   cd observability-stack && ./scripts/upgrade-orchestrator.sh

   # CHOM
   cd chom && composer update && npm update
   ```

2. **Regular Security Audits**
   ```bash
   # Run security tests
   make test-security

   # Check for vulnerable dependencies
   cd chom && composer audit
   cd chom && npm audit
   ```

3. **Monitor Security Advisories**
   - GitHub Security Advisories: https://github.com/calounx/mentat/security/advisories
   - Subscribe to security mailing lists for Laravel, Prometheus, Grafana, etc.

4. **Backup Regularly**
   - Database backups (automated in CHOM)
   - Configuration backups
   - SSH keys and secrets

5. **Incident Response**
   - Document security incidents
   - Notify affected users promptly
   - Publish security advisories for confirmed vulnerabilities

---

## Known Security Considerations

### Observability Stack

- **Shell Script Execution**: Scripts run with elevated privileges during installation. Review code before running.
- **Network Exposure**: Monitoring services may be exposed on the network. Use firewall rules.
- **Config Files**: `config/global.yaml` may contain sensitive data. It's in .gitignore.

### CHOM

- **SSH Operations**: CHOM executes SSH commands on VPS servers. Ensure key security.
- **Database Access**: Proper credentials required for MySQL exporter access.
- **Stripe Webhooks**: Validate webhook signatures to prevent unauthorized requests.
- **File Uploads**: Validate and sanitize all uploaded files (backups, site files).

---

## Security Checklist

### Before Deployment

- [ ] All secrets are in environment variables or secure storage
- [ ] No sensitive data in git repository
- [ ] SSL/TLS configured for all external endpoints
- [ ] Firewall rules configured appropriately
- [ ] Strong passwords for all services
- [ ] SSH key-based authentication enabled
- [ ] Database credentials are strong and unique
- [ ] `APP_DEBUG=false` in production (CHOM)
- [ ] Rate limiting configured
- [ ] CORS configured properly (CHOM)

### During Operation

- [ ] Monitor security logs regularly
- [ ] Apply security patches promptly
- [ ] Rotate credentials periodically
- [ ] Review access logs for suspicious activity
- [ ] Keep backup encryption keys secure
- [ ] Test disaster recovery procedures

### After Incident

- [ ] Document the incident
- [ ] Identify root cause
- [ ] Apply fixes
- [ ] Notify affected parties
- [ ] Update security procedures
- [ ] Publish security advisory if needed

---

## Contact

For security concerns, please use GitHub Security Advisories or open an issue with the `security` label.

For general support:
- Observability Stack: https://github.com/calounx/mentat/issues
- CHOM: support@chom.io

---

## Acknowledgments

We appreciate the security research community's efforts in keeping our projects secure. Security researchers who responsibly disclose vulnerabilities will be acknowledged in our release notes (with their permission).
