name: Release Workflow

on:
  release:
    types: [published]
  workflow_dispatch: # Allow manual trigger for testing
    inputs:
      tag:
        description: 'Release tag (e.g., v4.3.0)'
        required: true
        type: string

permissions:
  contents: write

jobs:
  build-and-release:
    name: Build Application and Generate Changelog
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Full history for changelog generation

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, xml, bcmath, curl, pdo, pdo_mysql, redis
          coverage: none
          tools: composer:v2

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'chom/package-lock.json'

      - name: Get release tag
        id: get_tag
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "tag=${{ inputs.tag }}" >> $GITHUB_OUTPUT
          else
            echo "tag=${{ github.event.release.tag_name }}" >> $GITHUB_OUTPUT
          fi

      - name: Get previous tag
        id: prev_tag
        run: |
          CURRENT_TAG="${{ steps.get_tag.outputs.tag }}"
          PREV_TAG=$(git tag -l --sort=-version:refname | grep -A1 "$CURRENT_TAG" | tail -1)
          if [ -z "$PREV_TAG" ]; then
            # If no previous tag, use first commit
            PREV_TAG=$(git rev-list --max-parents=0 HEAD)
          fi
          echo "prev_tag=$PREV_TAG" >> $GITHUB_OUTPUT
          echo "Previous tag: $PREV_TAG"

      - name: Generate Changelog
        id: changelog
        run: |
          CURRENT_TAG="${{ steps.get_tag.outputs.tag }}"
          PREV_TAG="${{ steps.prev_tag.outputs.prev_tag }}"

          echo "# Changelog" > CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "## Changes from $PREV_TAG to $CURRENT_TAG" >> CHANGELOG.md
          echo "" >> CHANGELOG.md

          # Generate changelog from commits
          git log --pretty=format:"- %s (%h)" $PREV_TAG..$CURRENT_TAG >> CHANGELOG.md

          echo "" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "## Statistics" >> CHANGELOG.md
          echo "" >> CHANGELOG.md

          # Count commits
          COMMIT_COUNT=$(git rev-list --count $PREV_TAG..$CURRENT_TAG)
          echo "- **Total Commits:** $COMMIT_COUNT" >> CHANGELOG.md

          # Count files changed
          FILES_CHANGED=$(git diff --numstat $PREV_TAG..$CURRENT_TAG | wc -l)
          echo "- **Files Changed:** $FILES_CHANGED" >> CHANGELOG.md

          # Count lines added/removed
          ADDITIONS=$(git diff --numstat $PREV_TAG..$CURRENT_TAG | awk '{sum+=$1} END {print sum}')
          DELETIONS=$(git diff --numstat $PREV_TAG..$CURRENT_TAG | awk '{sum+=$2} END {print sum}')
          echo "- **Lines Added:** $ADDITIONS" >> CHANGELOG.md
          echo "- **Lines Deleted:** $DELETIONS" >> CHANGELOG.md

          cat CHANGELOG.md

      - name: Install Composer dependencies
        working-directory: chom
        run: |
          composer install --prefer-dist --no-dev --no-interaction --no-progress --optimize-autoloader

      - name: Install NPM dependencies
        working-directory: chom
        run: npm ci

      - name: Build frontend assets
        working-directory: chom
        run: npm run build

      - name: Prepare release directory
        run: |
          mkdir -p release
          rsync -av --progress chom/ release/ \
            --exclude .git \
            --exclude .github \
            --exclude node_modules \
            --exclude tests \
            --exclude .env \
            --exclude .env.example \
            --exclude storage/logs/* \
            --exclude storage/framework/cache/* \
            --exclude storage/framework/sessions/* \
            --exclude storage/framework/views/* \
            --exclude .gitignore \
            --exclude .gitattributes \
            --exclude phpunit.xml \
            --exclude phpstan.neon \
            --exclude phpmd.xml \
            --exclude .php-cs-fixer.php

      - name: Create release archive
        run: |
          cd release
          zip -r ../chom-${{ steps.get_tag.outputs.tag }}.zip . -x "*.git*"
          cd ..

          # Create checksums
          sha256sum chom-${{ steps.get_tag.outputs.tag }}.zip > checksums.txt
          md5sum chom-${{ steps.get_tag.outputs.tag }}.zip >> checksums.txt

      - name: Upload release assets
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.get_tag.outputs.tag }}
          body_path: CHANGELOG.md
          files: |
            chom-${{ steps.get_tag.outputs.tag }}.zip
            checksums.txt
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload changelog artifact
        uses: actions/upload-artifact@v4
        with:
          name: changelog
          path: CHANGELOG.md

      - name: Upload release archive artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-archive
          path: chom-${{ steps.get_tag.outputs.tag }}.zip

  notify:
    name: Send Release Notifications
    runs-on: ubuntu-latest
    needs: build-and-release
    if: success()

    steps:
      - name: Send success notification
        run: |
          echo "Release ${{ github.event.release.tag_name }} published successfully!"

          # Optional: Send to Slack if webhook is configured
          if [ -n "${{ secrets.SLACK_WEBHOOK_URL }}" ]; then
            curl -X POST -H 'Content-type: application/json' \
              --data "{\"text\":\"ðŸš€ New release ${{ github.event.release.tag_name }} published successfully!\"}" \
              "${{ secrets.SLACK_WEBHOOK_URL }}"
          fi
