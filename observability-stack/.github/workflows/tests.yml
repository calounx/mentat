name: Observability Stack Tests

on:
  push:
    branches: [ master, main, develop ]
    paths:
      - 'scripts/**'
      - 'modules/**'
      - 'tests/**'
      - '.github/workflows/tests.yml'
  pull_request:
    branches: [ master, main, develop ]
    paths:
      - 'scripts/**'
      - 'modules/**'
      - 'tests/**'
      - '.github/workflows/tests.yml'
  workflow_dispatch:

jobs:
  shellcheck:
    name: ShellCheck
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install ShellCheck
        run: |
          sudo apt-get update
          sudo apt-get install -y shellcheck

      - name: Run ShellCheck
        run: |
          ./tests/test-shellcheck.sh

      - name: Upload ShellCheck results
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: shellcheck-results
          path: shellcheck-results.txt
          retention-days: 7

  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Bats
        run: |
          git clone --depth 1 https://github.com/bats-core/bats-core.git /tmp/bats-core
          cd /tmp/bats-core
          sudo ./install.sh /usr/local

      - name: Install Bats support libraries
        run: |
          # Install bats-support
          git clone --depth 1 https://github.com/bats-core/bats-support.git /tmp/bats-support
          sudo mkdir -p /usr/local/lib/bats
          sudo cp -r /tmp/bats-support /usr/local/lib/bats/bats-support

          # Install bats-assert
          git clone --depth 1 https://github.com/bats-core/bats-assert.git /tmp/bats-assert
          sudo cp -r /tmp/bats-assert /usr/local/lib/bats/bats-assert

      - name: Run unit tests
        run: |
          bats tests/test-common.bats --formatter junit > test-results-unit.xml || true
          bats tests/test-common.bats

      - name: Upload unit test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: unit-test-results
          path: test-results-unit.xml
          retention-days: 7

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Bats
        run: |
          git clone --depth 1 https://github.com/bats-core/bats-core.git /tmp/bats-core
          cd /tmp/bats-core
          sudo ./install.sh /usr/local

      - name: Install Bats support libraries
        run: |
          git clone --depth 1 https://github.com/bats-core/bats-support.git /tmp/bats-support
          sudo mkdir -p /usr/local/lib/bats
          sudo cp -r /tmp/bats-support /usr/local/lib/bats/bats-support

          git clone --depth 1 https://github.com/bats-core/bats-assert.git /tmp/bats-assert
          sudo cp -r /tmp/bats-assert /usr/local/lib/bats/bats-assert

      - name: Run integration tests
        run: |
          bats tests/test-integration.bats --formatter junit > test-results-integration.xml || true
          bats tests/test-integration.bats

      - name: Upload integration test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-results
          path: test-results-integration.xml
          retention-days: 7

  security-tests:
    name: Security Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Bats
        run: |
          git clone --depth 1 https://github.com/bats-core/bats-core.git /tmp/bats-core
          cd /tmp/bats-core
          sudo ./install.sh /usr/local

      - name: Install Bats support libraries
        run: |
          git clone --depth 1 https://github.com/bats-core/bats-support.git /tmp/bats-support
          sudo mkdir -p /usr/local/lib/bats
          sudo cp -r /tmp/bats-support /usr/local/lib/bats/bats-support

          git clone --depth 1 https://github.com/bats-core/bats-assert.git /tmp/bats-assert
          sudo cp -r /tmp/bats-assert /usr/local/lib/bats/bats-assert

      - name: Run security tests
        run: |
          bats tests/test-security.bats --formatter junit > test-results-security.xml || true
          bats tests/test-security.bats

      - name: Upload security test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-test-results
          path: test-results-security.xml
          retention-days: 7

  yaml-validation:
    name: YAML Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install yamllint
        run: |
          sudo apt-get update
          sudo apt-get install -y yamllint

      - name: Validate YAML files
        run: |
          # Create yamllint config
          cat > .yamllint <<EOF
          ---
          extends: default
          rules:
            line-length:
              max: 120
              level: warning
            indentation:
              spaces: 2
            comments:
              min-spaces-from-content: 1
          EOF

          # Run yamllint on all YAML files
          find . -name "*.yaml" -o -name "*.yml" | xargs yamllint -c .yamllint

  syntax-check:
    name: Bash Syntax Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check bash syntax
        run: |
          # Find and check all shell scripts
          find scripts -name "*.sh" -type f -exec bash -n {} \;
          find modules -name "*.sh" -type f -exec bash -n {} \;

  coverage-report:
    name: Test Coverage Report
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests, security-tests]
    if: always()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all test results
        uses: actions/download-artifact@v4
        with:
          path: test-results

      - name: Generate coverage summary
        run: |
          echo "# Test Coverage Summary" > coverage-summary.md
          echo "" >> coverage-summary.md
          echo "## Test Results" >> coverage-summary.md
          echo "" >> coverage-summary.md

          # Count test files
          total_tests=$(find tests -name "*.bats" | wc -l)
          echo "Total test suites: $total_tests" >> coverage-summary.md

          # Count total test cases (approximate)
          total_cases=$(grep -r "^@test" tests/*.bats | wc -l)
          echo "Total test cases: $total_cases" >> coverage-summary.md

          echo "" >> coverage-summary.md
          echo "## Coverage Areas" >> coverage-summary.md
          echo "" >> coverage-summary.md
          echo "- Unit Tests: Common library functions" >> coverage-summary.md
          echo "- Integration Tests: Module workflows" >> coverage-summary.md
          echo "- Security Tests: Permission and credential handling" >> coverage-summary.md
          echo "- ShellCheck: Code quality analysis" >> coverage-summary.md

      - name: Upload coverage summary
        uses: actions/upload-artifact@v4
        with:
          name: coverage-summary
          path: coverage-summary.md
          retention-days: 30

  all-tests-passed:
    name: All Tests Passed
    runs-on: ubuntu-latest
    needs: [shellcheck, unit-tests, integration-tests, security-tests, yaml-validation, syntax-check]
    if: always()
    steps:
      - name: Check test results
        run: |
          if [ "${{ needs.shellcheck.result }}" != "success" ] || \
             [ "${{ needs.unit-tests.result }}" != "success" ] || \
             [ "${{ needs.integration-tests.result }}" != "success" ] || \
             [ "${{ needs.security-tests.result }}" != "success" ] || \
             [ "${{ needs.yaml-validation.result }}" != "success" ] || \
             [ "${{ needs.syntax-check.result }}" != "success" ]; then
            echo "One or more test jobs failed"
            exit 1
          fi
          echo "All tests passed successfully!"
