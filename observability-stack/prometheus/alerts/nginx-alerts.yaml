# Nginx Alerts
# Alert rules for Nginx web server monitoring

groups:
  #=============================================================================
  # Nginx Availability
  #=============================================================================
  - name: nginx:availability
    rules:
      - alert: NginxDown
        expr: nginx_up == 0
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "Nginx down on {{ $labels.instance }}"
          description: "Nginx has been down for 2 minutes"

      - alert: NginxHighHttp4xxErrorRate
        expr: |
          sum(rate(nginx_http_requests_total{status=~"^4.."}[5m])) by (instance)
          /
          sum(rate(nginx_http_requests_total[5m])) by (instance)
          > 0.1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High 4xx error rate on {{ $labels.instance }}"
          description: "{{ $value | printf \"%.1f\" }}% of requests returning 4xx"

      - alert: NginxHighHttp5xxErrorRate
        expr: |
          sum(rate(nginx_http_requests_total{status=~"^5.."}[5m])) by (instance)
          /
          sum(rate(nginx_http_requests_total[5m])) by (instance)
          > 0.05
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "High 5xx error rate on {{ $labels.instance }}"
          description: "{{ $value | printf \"%.1f\" }}% of requests returning 5xx"

      - alert: NginxLatencyHigh
        expr: |
          histogram_quantile(0.99, sum(rate(nginx_http_request_duration_seconds_bucket[5m])) by (le, instance))
          > 3
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High latency on {{ $labels.instance }}"
          description: "P99 latency: {{ $value | printf \"%.2f\" }}s"

  #=============================================================================
  # Nginx Connections
  #=============================================================================
  - name: nginx:connections
    rules:
      - alert: NginxHighConnectionWaiting
        expr: nginx_connections_waiting > 1000
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High waiting connections on {{ $labels.instance }}"
          description: "{{ $value }} connections waiting"

      - alert: NginxDroppedConnections
        expr: rate(nginx_connections_accepted[5m]) - rate(nginx_connections_handled[5m]) > 0
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Nginx dropping connections on {{ $labels.instance }}"
          description: "{{ $value | printf \"%.1f\" }} connections/s being dropped"

  #=============================================================================
  # Nginx SSL
  #=============================================================================
  - name: nginx:ssl
    rules:
      - alert: NginxSslCertificateExpiringSoon
        expr: nginx_ssl_handshakes > 0 and (nginx_ssl_certificate_expiry_time - time()) / 86400 < 30
        for: 1h
        labels:
          severity: warning
        annotations:
          summary: "SSL certificate expiring soon on {{ $labels.instance }}"
          description: "Certificate expires in {{ $value | printf \"%.0f\" }} days"

      - alert: NginxSslCertificateExpired
        expr: nginx_ssl_certificate_expiry_time < time()
        for: 0m
        labels:
          severity: critical
        annotations:
          summary: "SSL certificate expired on {{ $labels.instance }}"
          description: "SSL certificate has expired!"
