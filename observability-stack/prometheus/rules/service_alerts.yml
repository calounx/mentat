# Service-Specific Alert Rules (Nginx, MySQL, PHP-FPM)
groups:
  # =========================================================================
  # NGINX ALERTS
  # =========================================================================
  - name: nginx_alerts
    rules:
      - alert: NginxDown
        expr: nginx_up == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Nginx is down on {{ $labels.instance }}"
          description: "Nginx service is not responding"

      - alert: NginxHighConnections
        expr: nginx_connections_active > 1000
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High Nginx connections on {{ $labels.instance }}"
          description: "Active connections: {{ $value }}"

      - alert: NginxHighConnectionsWaiting
        expr: nginx_connections_waiting > 500
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High Nginx waiting connections on {{ $labels.instance }}"
          description: "Waiting connections: {{ $value }}"

      - alert: NginxHighHttp4xxRate
        expr: sum(rate(nginx_http_requests_total{status=~"4.."}[5m])) by (instance) / sum(rate(nginx_http_requests_total[5m])) by (instance) * 100 > 5
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High 4xx error rate on {{ $labels.instance }}"
          description: "4xx error rate is {{ $value | printf \"%.1f\" }}%"

      - alert: NginxHighHttp5xxRate
        expr: sum(rate(nginx_http_requests_total{status=~"5.."}[5m])) by (instance) / sum(rate(nginx_http_requests_total[5m])) by (instance) * 100 > 1
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "High 5xx error rate on {{ $labels.instance }}"
          description: "5xx error rate is {{ $value | printf \"%.1f\" }}%"

  # =========================================================================
  # MYSQL/MARIADB ALERTS
  # =========================================================================
  - name: mysql_alerts
    rules:
      - alert: MySQLDown
        expr: mysql_up == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "MySQL is down on {{ $labels.instance }}"
          description: "MySQL/MariaDB service is not responding"

      - alert: MySQLTooManyConnections
        expr: mysql_global_status_threads_connected / mysql_global_variables_max_connections * 100 > 80
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "MySQL connections high on {{ $labels.instance }}"
          description: "{{ $value | printf \"%.1f\" }}% of max connections used"

      - alert: MySQLConnectionsCritical
        expr: mysql_global_status_threads_connected / mysql_global_variables_max_connections * 100 > 95
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "MySQL connections critical on {{ $labels.instance }}"
          description: "{{ $value | printf \"%.1f\" }}% of max connections used"

      - alert: MySQLSlowQueries
        expr: rate(mysql_global_status_slow_queries[5m]) > 0.1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "MySQL slow queries detected on {{ $labels.instance }}"
          description: "{{ $value | printf \"%.2f\" }} slow queries per second"

      - alert: MySQLHighQPS
        expr: rate(mysql_global_status_queries[5m]) > 1000
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High MySQL QPS on {{ $labels.instance }}"
          description: "{{ $value | printf \"%.0f\" }} queries per second"

      - alert: MySQLInnoDBLogWaits
        expr: rate(mysql_global_status_innodb_log_waits[5m]) > 0
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "InnoDB log waits on {{ $labels.instance }}"
          description: "InnoDB is waiting for log buffer - consider increasing innodb_log_buffer_size"

      - alert: MySQLReplicationLag
        expr: mysql_slave_status_seconds_behind_master > 30
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "MySQL replication lag on {{ $labels.instance }}"
          description: "Replication is {{ $value }} seconds behind master"

      - alert: MySQLReplicationNotRunning
        expr: mysql_slave_status_slave_io_running == 0 or mysql_slave_status_slave_sql_running == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "MySQL replication stopped on {{ $labels.instance }}"
          description: "Replication IO or SQL thread is not running"

  # =========================================================================
  # PHP-FPM ALERTS
  # =========================================================================
  - name: phpfpm_alerts
    rules:
      - alert: PHPFPMDown
        expr: phpfpm_up == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "PHP-FPM is down on {{ $labels.instance }}"
          description: "PHP-FPM service is not responding"

      - alert: PHPFPMHighActiveProcesses
        expr: phpfpm_active_processes / phpfpm_total_processes * 100 > 80
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "PHP-FPM high active processes on {{ $labels.instance }}"
          description: "{{ $value | printf \"%.1f\" }}% of PHP-FPM processes are active"

      - alert: PHPFPMMaxChildrenReached
        expr: rate(phpfpm_max_children_reached_total[5m]) > 0
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "PHP-FPM max children reached on {{ $labels.instance }}"
          description: "PHP-FPM pool is hitting max_children limit - consider increasing"

      - alert: PHPFPMSlowRequests
        expr: rate(phpfpm_slow_requests_total[5m]) > 0.1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "PHP-FPM slow requests on {{ $labels.instance }}"
          description: "{{ $value | printf \"%.2f\" }} slow requests per second"

      - alert: PHPFPMQueueFull
        expr: phpfpm_listen_queue / phpfpm_listen_queue_len * 100 > 80
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "PHP-FPM listen queue filling up on {{ $labels.instance }}"
          description: "Queue is {{ $value | printf \"%.1f\" }}% full - requests are backing up"

  # =========================================================================
  # FAIL2BAN ALERTS
  # =========================================================================
  - name: fail2ban_alerts
    rules:
      - alert: Fail2banDown
        expr: f2b_up == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Fail2ban is down on {{ $labels.instance }}"
          description: "Fail2ban service is not responding"

      - alert: Fail2banHighBanRate
        expr: rate(f2b_jail_banned_total[5m]) > 1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High ban rate on {{ $labels.instance }}"
          description: "Fail2ban is banning {{ $value | printf \"%.2f\" }} IPs per second"

      - alert: Fail2banHighFailedAttempts
        expr: rate(f2b_jail_failed_total[5m]) > 10
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High failed attempts rate on {{ $labels.instance }}"
          description: "Fail2ban detecting {{ $value | printf \"%.2f\" }} failed attempts per second"

      - alert: Fail2banManyCurrentBans
        expr: sum by (instance) (f2b_jail_banned_current) > 50
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Many IPs currently banned on {{ $labels.instance }}"
          description: "{{ $value }} IPs currently banned - possible attack in progress"

      - alert: Fail2banExporterErrors
        expr: increase(f2b_errors[5m]) > 0
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "Fail2ban exporter errors on {{ $labels.instance }}"
          description: "Fail2ban exporter is encountering errors (socket or request failures)"
