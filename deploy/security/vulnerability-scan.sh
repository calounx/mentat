#!/bin/bash
# ============================================================================
# Vulnerability Scanner Script
# ============================================================================
# Purpose: Scan for CVEs, outdated packages, dependency vulnerabilities
# Coverage: OS packages, PHP dependencies, Docker images, exposed services
# Compliance: OWASP, PCI DSS 6.2, SOC 2
# ============================================================================

set -euo pipefail

# Configuration
APP_ROOT="${APP_ROOT:-/var/www/chom}"
REPORT_DIR="/var/log/chom/vulnerability-scans"
REPORT_FILE="$REPORT_DIR/scan_$(date +%Y%m%d_%H%M%S).json"
SEVERITY_CRITICAL=0
SEVERITY_HIGH=0
SEVERITY_MEDIUM=0
SEVERITY_LOW=0

# Color output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# Logging
log_info() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

log_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

log_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

log_critical() {
    echo -e "${RED}[CRITICAL]${NC} $1"
    ((SEVERITY_CRITICAL++))
}

log_high() {
    echo -e "${RED}[HIGH]${NC} $1"
    ((SEVERITY_HIGH++))
}

log_medium() {
    echo -e "${YELLOW}[MEDIUM]${NC} $1"
    ((SEVERITY_MEDIUM++))
}

log_low() {
    echo -e "${YELLOW}[LOW]${NC} $1"
    ((SEVERITY_LOW++))
}

# Check if running as root
check_root() {
    if [[ $EUID -ne 0 ]]; then
        log_error "This script must be run as root"
        exit 1
    fi
}

# Initialize report
init_report() {
    mkdir -p "$REPORT_DIR"
    chmod 750 "$REPORT_DIR"

    cat > "$REPORT_FILE" <<EOF
{
  "scan_date": "$(date -Iseconds)",
  "server": "$(hostname)",
  "scanner_version": "1.0",
  "vulnerabilities": {
    "critical": [],
    "high": [],
    "medium": [],
    "low": []
  }
}
EOF
}

# Install scanning tools
install_tools() {
    log_info "Installing vulnerability scanning tools..."

    apt-get update -qq

    # Install debsecan for Debian security updates
    apt-get install -y debsecan apt-show-versions

    # Install Composer for PHP dependency scanning
    if [[ ! -f /usr/local/bin/composer ]]; then
        curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer
    fi

    log_success "Scanning tools installed"
}

# Scan OS packages for CVEs
scan_os_packages() {
    log_info "Scanning OS packages for known vulnerabilities..."

    # Update CVE database
    apt-get update -qq 2>/dev/null

    # Scan for vulnerable packages
    local vulnerable_packages=$(debsecan --suite bookworm --format detail 2>/dev/null || true)

    if [[ -n "$vulnerable_packages" ]]; then
        local critical_count=$(echo "$vulnerable_packages" | grep -c "urgency=high" || echo "0")
        local high_count=$(echo "$vulnerable_packages" | grep -c "urgency=medium" || echo "0")

        if [[ $critical_count -gt 0 ]]; then
            log_critical "Found $critical_count critical OS package vulnerabilities"
        fi

        if [[ $high_count -gt 0 ]]; then
            log_high "Found $high_count high severity OS package vulnerabilities"
        fi

        # Save to report
        echo "$vulnerable_packages" > "$REPORT_DIR/os_packages_$(date +%Y%m%d).txt"
        log_info "OS package vulnerabilities saved to report"
    else
        log_success "No OS package vulnerabilities found"
    fi

    # Check for available security updates
    local security_updates=$(apt-get upgrade -s 2>/dev/null | grep -i security | wc -l)
    if [[ $security_updates -gt 0 ]]; then
        log_high "$security_updates security updates available"
        apt-get upgrade -s 2>/dev/null | grep -i security > "$REPORT_DIR/security_updates_$(date +%Y%m%d).txt"
    else
        log_success "OS packages are up to date"
    fi
}

# Scan PHP dependencies
scan_php_dependencies() {
    log_info "Scanning PHP dependencies for vulnerabilities..."

    if [[ ! -d "$APP_ROOT" ]]; then
        log_warning "Application directory not found: $APP_ROOT"
        return 0
    fi

    cd "$APP_ROOT"

    # Check if composer.lock exists
    if [[ ! -f "composer.lock" ]]; then
        log_warning "composer.lock not found, skipping PHP dependency scan"
        return 0
    fi

    # Run Composer audit
    local audit_output=$(composer audit --format=json 2>/dev/null || echo '{"advisories":[]}')

    # Parse audit results
    local advisory_count=$(echo "$audit_output" | jq '.advisories | length' 2>/dev/null || echo "0")

    if [[ $advisory_count -gt 0 ]]; then
        log_high "Found $advisory_count PHP dependency vulnerabilities"
        echo "$audit_output" > "$REPORT_DIR/php_dependencies_$(date +%Y%m%d).json"

        # Display details
        composer audit --format=plain 2>/dev/null || true
    else
        log_success "No PHP dependency vulnerabilities found"
    fi
}

# Scan for outdated packages
scan_outdated_packages() {
    log_info "Scanning for outdated packages..."

    # Check Debian packages
    local outdated_count=$(apt-show-versions | grep "newer version" | wc -l)

    if [[ $outdated_count -gt 0 ]]; then
        log_medium "$outdated_count packages have newer versions available"
        apt-show-versions | grep "newer version" > "$REPORT_DIR/outdated_packages_$(date +%Y%m%d).txt"
    else
        log_success "All packages are up to date"
    fi

    # Check PHP packages
    if [[ -d "$APP_ROOT" ]]; then
        cd "$APP_ROOT"
        if [[ -f "composer.json" ]]; then
            local outdated_php=$(composer outdated --direct --format=json 2>/dev/null | jq '.installed | length' 2>/dev/null || echo "0")
            if [[ $outdated_php -gt 0 ]]; then
                log_medium "$outdated_php PHP packages have updates available"
                composer outdated --direct > "$REPORT_DIR/outdated_php_$(date +%Y%m%d).txt" 2>/dev/null || true
            fi
        fi
    fi
}

# Scan for weak SSL/TLS
scan_ssl() {
    log_info "Scanning SSL/TLS configuration..."

    # Check for SSL certificates
    if [[ -d "/etc/letsencrypt/live" ]]; then
        for cert_dir in /etc/letsencrypt/live/*/; do
            if [[ -f "${cert_dir}cert.pem" ]]; then
                local domain=$(basename "$cert_dir")
                local cert_file="${cert_dir}cert.pem"

                # Check expiration
                local expiry=$(openssl x509 -in "$cert_file" -noout -enddate | cut -d= -f2)
                local expiry_epoch=$(date -d "$expiry" +%s)
                local now_epoch=$(date +%s)
                local days_left=$(( ($expiry_epoch - $now_epoch) / 86400 ))

                if [[ $days_left -lt 7 ]]; then
                    log_critical "SSL certificate for $domain expires in $days_left days"
                elif [[ $days_left -lt 30 ]]; then
                    log_medium "SSL certificate for $domain expires in $days_left days"
                fi

                # Check key size
                local key_size=$(openssl x509 -in "$cert_file" -noout -text | grep "Public-Key:" | grep -oP '\d+' | head -1)
                if [[ $key_size -lt 2048 ]]; then
                    log_high "SSL certificate for $domain uses weak key size: $key_size bits"
                fi
            fi
        done
    fi

    # Check Nginx SSL configuration
    if [[ -d "/etc/nginx/sites-enabled" ]]; then
        # Check for weak protocols
        if grep -r "ssl_protocols.*TLSv1\.0\|TLSv1\.1" /etc/nginx/sites-enabled/ 2>/dev/null; then
            log_high "Weak TLS protocols (1.0/1.1) enabled in Nginx"
        fi

        # Check for weak ciphers
        if grep -r "ssl_ciphers.*DES\|RC4\|MD5" /etc/nginx/sites-enabled/ 2>/dev/null; then
            log_high "Weak ciphers enabled in Nginx"
        fi
    fi
}

# Scan for default credentials
scan_default_credentials() {
    log_info "Scanning for default credentials..."

    local issues=0

    # Check PostgreSQL default passwords
    if command -v psql &> /dev/null; then
        if sudo -u postgres psql -c "\du" 2>/dev/null | grep -q "postgres"; then
            # Try to connect with empty password
            if PGPASSWORD="" psql -U postgres -c "SELECT 1" &>/dev/null; then
                log_critical "PostgreSQL postgres user has no password!"
                ((issues++))
            fi
        fi
    fi

    # Check for weak passwords in .env
    if [[ -f "$APP_ROOT/.env" ]]; then
        if grep -qE "PASSWORD=(password|secret|123456|admin)" "$APP_ROOT/.env"; then
            log_critical "Weak or default passwords found in .env"
            ((issues++))
        fi
    fi

    if [[ $issues -eq 0 ]]; then
        log_success "No default credentials found"
    fi
}

# Scan exposed services
scan_exposed_services() {
    log_info "Scanning for exposed services..."

    # Check listening ports
    local listening_ports=$(ss -tuln | grep LISTEN | awk '{print $5}' | cut -d: -f2 | sort -u)

    log_info "Listening ports:"
    for port in $listening_ports; do
        local service=$(ss -tuln | grep ":$port " | head -1)
        echo "  Port $port: $service"
    done

    # Check for dangerous open ports
    local dangerous_ports=("23" "21" "25" "110" "143" "3306" "5432" "6379" "27017")

    for port in "${dangerous_ports[@]}"; do
        if echo "$listening_ports" | grep -q "^${port}$"; then
            local service_name=""
            case $port in
                23) service_name="Telnet" ;;
                21) service_name="FTP" ;;
                25) service_name="SMTP" ;;
                110) service_name="POP3" ;;
                143) service_name="IMAP" ;;
                3306) service_name="MySQL" ;;
                5432) service_name="PostgreSQL" ;;
                6379) service_name="Redis" ;;
                27017) service_name="MongoDB" ;;
            esac

            log_high "$service_name exposed on port $port (should be firewalled)"
        fi
    done
}

# Scan file permissions
scan_file_permissions() {
    log_info "Scanning for insecure file permissions..."

    # World-writable files
    local world_writable=$(find / -xdev -type f -perm -002 ! -path "/proc/*" ! -path "/sys/*" 2>/dev/null | wc -l)
    if [[ $world_writable -gt 0 ]]; then
        log_high "Found $world_writable world-writable files"
    fi

    # SUID/SGID files
    local suid_files=$(find / -xdev -type f \( -perm -4000 -o -perm -2000 \) ! -path "/proc/*" 2>/dev/null)
    local suid_count=$(echo "$suid_files" | wc -l)

    # Save SUID files for comparison
    echo "$suid_files" > "$REPORT_DIR/suid_files_$(date +%Y%m%d).txt"
    log_info "Found $suid_count SUID/SGID files (baseline saved)"

    # Check .env permissions
    if [[ -f "$APP_ROOT/.env" ]]; then
        local env_perm=$(stat -c %a "$APP_ROOT/.env")
        if [[ "$env_perm" != "600" ]]; then
            log_critical ".env file has insecure permissions: $env_perm"
        fi
    fi
}

# Scan for common misconfigurations
scan_misconfigurations() {
    log_info "Scanning for common misconfigurations..."

    # Check SSH
    if [[ -f "/etc/ssh/sshd_config" ]]; then
        if grep -q "^PermitRootLogin yes" /etc/ssh/sshd_config; then
            log_high "SSH root login is enabled"
        fi

        if grep -q "^PasswordAuthentication yes" /etc/ssh/sshd_config; then
            log_medium "SSH password authentication is enabled"
        fi
    fi

    # Check PHP
    if [[ -f "/etc/php/8.2/fpm/php.ini" ]]; then
        if grep -q "^display_errors = On" /etc/php/8.2/fpm/php.ini; then
            log_high "PHP display_errors is enabled"
        fi

        if grep -q "^expose_php = On" /etc/php/8.2/fpm/php.ini; then
            log_low "PHP version is exposed in headers"
        fi
    fi

    # Check Laravel
    if [[ -f "$APP_ROOT/.env" ]]; then
        if grep -q "^APP_DEBUG=true" "$APP_ROOT/.env"; then
            log_critical "Laravel debug mode is enabled in production"
        fi

        if grep -q "^APP_ENV=local" "$APP_ROOT/.env"; then
            log_high "Laravel environment is set to 'local'"
        fi
    fi
}

# Generate HTML report
generate_html_report() {
    log_info "Generating HTML report..."

    local html_report="$REPORT_DIR/scan_$(date +%Y%m%d_%H%M%S).html"

    cat > "$html_report" <<EOF
<!DOCTYPE html>
<html>
<head>
    <title>CHOM Vulnerability Scan Report</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .header { background: #333; color: white; padding: 20px; }
        .critical { color: #d32f2f; font-weight: bold; }
        .high { color: #f57c00; font-weight: bold; }
        .medium { color: #fbc02d; }
        .low { color: #388e3c; }
        .pass { color: #4caf50; }
        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        th, td { padding: 10px; text-align: left; border: 1px solid #ddd; }
        th { background: #f5f5f5; }
    </style>
</head>
<body>
    <div class="header">
        <h1>CHOM Vulnerability Scan Report</h1>
        <p>Date: $(date)</p>
        <p>Server: $(hostname)</p>
    </div>

    <h2>Summary</h2>
    <table>
        <tr>
            <th>Severity</th>
            <th>Count</th>
        </tr>
        <tr class="critical">
            <td>Critical</td>
            <td>$SEVERITY_CRITICAL</td>
        </tr>
        <tr class="high">
            <td>High</td>
            <td>$SEVERITY_HIGH</td>
        </tr>
        <tr class="medium">
            <td>Medium</td>
            <td>$SEVERITY_MEDIUM</td>
        </tr>
        <tr class="low">
            <td>Low</td>
            <td>$SEVERITY_LOW</td>
        </tr>
    </table>

    <h2>Recommendations</h2>
    <ul>
        <li>Update all packages with security vulnerabilities</li>
        <li>Review and fix all critical and high severity issues immediately</li>
        <li>Schedule regular vulnerability scans (weekly recommended)</li>
        <li>Monitor security advisories for installed software</li>
    </ul>

    <p><em>Generated by CHOM Vulnerability Scanner v1.0</em></p>
</body>
</html>
EOF

    log_success "HTML report generated: $html_report"
}

# Display summary
display_summary() {
    echo ""
    echo "=============================================="
    echo "Vulnerability Scan Summary"
    echo "=============================================="
    echo ""
    echo "Critical: $SEVERITY_CRITICAL"
    echo "High:     $SEVERITY_HIGH"
    echo "Medium:   $SEVERITY_MEDIUM"
    echo "Low:      $SEVERITY_LOW"
    echo ""
    echo "Report: $REPORT_FILE"
    echo ""

    if [[ $SEVERITY_CRITICAL -gt 0 ]]; then
        log_critical "CRITICAL vulnerabilities found - Immediate action required!"
        return 2
    elif [[ $SEVERITY_HIGH -gt 0 ]]; then
        log_high "HIGH severity vulnerabilities found - Action required"
        return 1
    else
        log_success "No critical or high severity vulnerabilities found"
        return 0
    fi
}

# Main execution
main() {
    log_info "Starting vulnerability scan..."
    echo ""

    check_root
    init_report
    install_tools
    scan_os_packages
    scan_php_dependencies
    scan_outdated_packages
    scan_ssl
    scan_default_credentials
    scan_exposed_services
    scan_file_permissions
    scan_misconfigurations
    generate_html_report
    display_summary
}

# Run main function
main "$@"
