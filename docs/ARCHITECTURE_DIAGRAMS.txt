# CHOM Production Architecture - Visual Diagrams
# Use these ASCII diagrams for documentation and presentations

================================================================================
1. COMPLETE SYSTEM ARCHITECTURE
================================================================================

┌──────────────────────────────────────────────────────────────────────────┐
│                         INTERNET / END USERS                              │
└───────────────────────────────┬──────────────────────────────────────────┘
                                │
                    ┌───────────▼────────────┐
                    │   DNS (arewel.com)     │
                    │  - landsraad → 51.77.* │
                    │  - mentat → 51.254.*   │
                    └───────┬────────┬────────┘
                            │        │
              ──────────────┘        └──────────────
              │                                     │
┌─────────────▼──────────────┐     ┌──────────────▼─────────────┐
│   Application VPS          │     │   Observability VPS        │
│   landsraad.arewel.com     │     │   mentat.arewel.com        │
│   51.77.150.96             │     │   51.254.139.78            │
├────────────────────────────┤     ├────────────────────────────┤
│                            │     │                            │
│  Web Layer                 │     │  Monitoring Stack          │
│  ├─ Nginx (80/443)        │     │  ├─ Prometheus (9090)      │
│  └─ SSL/TLS               │     │  ├─ Grafana (3000)         │
│                            │     │  ├─ Loki (3100)            │
│  Application Layer         │     │  ├─ Tempo (3200)           │
│  ├─ PHP 8.2-FPM           │     │  └─ Alertmanager (9093)    │
│  ├─ Laravel CHOM          │◄────┤                            │
│  └─ Queue Workers         │     │  Collectors                │
│                            │────►│  ├─ Alloy                  │
│  Data Layer                │     │  └─ Node Exporter          │
│  ├─ MySQL 8.0             │     │                            │
│  ├─ Redis (Cache)         │     │  Storage                   │
│  └─ Redis (Queue)         │     │  └─ Prometheus TSDB        │
│                            │     │                            │
│  Exporters (Metrics)       │     │  Alerts                    │
│  ├─ Node (:9100)          │     │  ├─ PagerDuty              │
│  ├─ Nginx (:9113)         │────►│  ├─ Slack                  │
│  ├─ MySQL (:9104)         │     │  └─ Email                  │
│  ├─ PHP-FPM (:9253)       │     │                            │
│  └─ Alloy (:12345)        │     │                            │
└────────────┬───────────────┘     └────────────────────────────┘
             │
             │ Backups
             ▼
┌────────────────────────────────────────────────────────────────┐
│                    Backup Storage                              │
│                                                                │
│  Local: /var/backups/chom/                                    │
│  ├─ Database (every 6h)                                       │
│  ├─ Files (daily)                                             │
│  └─ Config (daily)                                            │
│                                                                │
│  Offsite: S3 / OVH Object Storage                             │
│  ├─ Encrypted backups                                         │
│  ├─ 90-day retention                                          │
│  └─ Glacier archival (30+ days)                               │
└────────────────────────────────────────────────────────────────┘

================================================================================
2. CI/CD DEPLOYMENT PIPELINE
================================================================================

┌──────────────┐
│  Developer   │
│  Git Push    │
└──────┬───────┘
       │
       ▼
┌─────────────────────────────────────────────────────────────────────┐
│                      GitHub Actions Pipeline                         │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  ┌────────────────────────────────────────────────────────────┐    │
│  │ STAGE 1: BUILD & TEST                                      │    │
│  ├────────────────────────────────────────────────────────────┤    │
│  │ ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐   │    │
│  │ │ Setup    │→ │ Install  │→ │   Test   │→ │  Build   │   │    │
│  │ │ PHP/Node │  │   Deps   │  │  Suite   │  │  Assets  │   │    │
│  │ └──────────┘  └──────────┘  └──────────┘  └──────────┘   │    │
│  │                                                            │    │
│  │ Output: deployment-package.tar.gz + checksums             │    │
│  └────────────────────────────────────────────────────────────┘    │
│                          │                                          │
│                          ▼                                          │
│  ┌────────────────────────────────────────────────────────────┐    │
│  │ STAGE 2: SECURITY SCAN                                     │    │
│  ├────────────────────────────────────────────────────────────┤    │
│  │ ┌────────┐  ┌──────────┐  ┌─────────┐  ┌──────────────┐  │    │
│  │ │ Trivy  │  │ Composer │  │   NPM   │  │  TruffleHog  │  │    │
│  │ │  Scan  │  │  Audit   │  │  Audit  │  │   Secrets    │  │    │
│  │ └────────┘  └──────────┘  └─────────┘  └──────────────┘  │    │
│  │                                                            │    │
│  │ Gate: Must pass all scans to continue                     │    │
│  └────────────────────────────────────────────────────────────┘    │
│                          │                                          │
│                          ▼                                          │
│  ┌────────────────────────────────────────────────────────────┐    │
│  │ STAGE 3: DEPLOYMENT (Blue-Green)                          │    │
│  ├────────────────────────────────────────────────────────────┤    │
│  │ 1. SSH to production server                               │    │
│  │ 2. Extract artifact to GREEN environment                  │    │
│  │ 3. Configure GREEN (env, storage links)                   │    │
│  │ 4. Backup database                                         │    │
│  │ 5. Run migrations on GREEN                                │    │
│  │ 6. Optimize GREEN (cache, routes)                         │    │
│  │ 7. Health check GREEN                                     │    │
│  │ 8. *** ATOMIC SWITCH *** (BLUE → GREEN)                   │    │
│  │ 9. Reload services (PHP-FPM, Nginx)                       │    │
│  │ 10. Post-deployment health checks                         │    │
│  │                                                            │    │
│  │ If any step fails: Automatic rollback to BLUE             │    │
│  └────────────────────────────────────────────────────────────┘    │
│                          │                                          │
│                          ▼                                          │
│  ┌────────────────────────────────────────────────────────────┐    │
│  │ STAGE 4: SMOKE TESTS                                      │    │
│  ├────────────────────────────────────────────────────────────┤    │
│  │ ✓ Homepage accessibility                                  │    │
│  │ ✓ Health endpoints (/health, /health/ready)              │    │
│  │ ✓ API endpoints                                           │    │
│  │ ✓ Database connectivity                                   │    │
│  │ ✓ Redis connectivity                                      │    │
│  │ ✓ Queue workers status                                    │    │
│  └────────────────────────────────────────────────────────────┘    │
│                          │                                          │
│                          ▼                                          │
│  ┌────────────────────────────────────────────────────────────┐    │
│  │ STAGE 5: OBSERVABILITY UPDATE                             │    │
│  ├────────────────────────────────────────────────────────────┤    │
│  │ ✓ Add deployment annotation to Grafana                    │    │
│  │ ✓ Update Prometheus labels                                │    │
│  │ ✓ Send Slack notification                                 │    │
│  └────────────────────────────────────────────────────────────┘    │
│                                                                      │
└──────────────────────────────┬───────────────────────────────────────┘
                               │
                    ┌──────────▼───────────┐
                    │   ✓ SUCCESS          │
                    │   Deployment: 12min  │
                    │   Downtime: 0s       │
                    └──────────────────────┘

================================================================================
3. BLUE-GREEN DEPLOYMENT FLOW
================================================================================

TIME: T-0 (Before Deployment)
┌──────────────────────────────────────────────────────────────────┐
│                     Production Environment                        │
│                                                                   │
│  ┌─────────────────┐                                             │
│  │   Nginx Proxy   │  ← 100% of traffic                         │
│  └────────┬────────┘                                             │
│           │                                                       │
│           ▼                                                       │
│  ┌─────────────────┐                                             │
│  │  BLUE (Active)  │  ← Current symlink points here             │
│  │  Version: 1.0   │                                             │
│  │  Status: LIVE   │                                             │
│  │  /releases/v1.0 │                                             │
│  └────────┬────────┘                                             │
│           │                                                       │
│  ┌────────▼────────────────────────┐                             │
│  │    Shared Resources             │                             │
│  │  - MySQL Database               │                             │
│  │  - Redis Cache/Queue            │                             │
│  │  - Storage (persistent files)   │                             │
│  └─────────────────────────────────┘                             │
└──────────────────────────────────────────────────────────────────┘

TIME: T+5 (Deployment in Progress)
┌──────────────────────────────────────────────────────────────────┐
│                     Production Environment                        │
│                                                                   │
│  ┌─────────────────┐                                             │
│  │   Nginx Proxy   │  ← 100% of traffic (still on BLUE)         │
│  └────────┬────────┘                                             │
│           │                                                       │
│           ▼                                                       │
│  ┌─────────────────┐      ┌─────────────────┐                   │
│  │  BLUE (Active)  │      │ GREEN (Staging) │ ← Being prepared  │
│  │  Version: 1.0   │      │  Version: 1.1   │                   │
│  │  Status: LIVE   │      │  Status: PREP   │                   │
│  │  /releases/v1.0 │      │  /releases/v1.1 │                   │
│  └────────┬────────┘      └────────┬────────┘                   │
│           │                        │                             │
│  ┌────────▼────────────────────────▼─────┐                       │
│  │      Shared Resources                 │                       │
│  │  - MySQL (migrations run on GREEN)    │                       │
│  │  - Redis Cache/Queue                  │                       │
│  │  - Storage (shared)                   │                       │
│  └───────────────────────────────────────┘                       │
└──────────────────────────────────────────────────────────────────┘

TIME: T+10 (After Switch - ATOMIC OPERATION)
┌──────────────────────────────────────────────────────────────────┐
│                     Production Environment                        │
│                                                                   │
│  ┌─────────────────┐                                             │
│  │   Nginx Proxy   │  ← 100% of traffic (now on GREEN)          │
│  └────────┬────────┘                                             │
│           │                                                       │
│           ▼                                                       │
│  ┌─────────────────┐      ┌─────────────────┐                   │
│  │ GREEN (Active)  │      │  BLUE (Standby) │ ← Kept for rollback
│  │  Version: 1.1   │      │  Version: 1.0   │                   │
│  │  Status: LIVE   │      │  Status: READY  │                   │
│  │  /releases/v1.1 │      │  /releases/v1.0 │                   │
│  └────────┬────────┘      └────────┬────────┘                   │
│           │                        │                             │
│  ┌────────▼────────────────────────▼─────┐                       │
│  │      Shared Resources                 │                       │
│  │  - MySQL (schema v1.1)                │                       │
│  │  - Redis Cache (cleared & warmed)     │                       │
│  │  - Storage (persistent)               │                       │
│  └───────────────────────────────────────┘                       │
└──────────────────────────────────────────────────────────────────┘

Rollback (if needed): Simply switch symlink back to BLUE (< 30 seconds)

================================================================================
4. CANARY DEPLOYMENT FLOW
================================================================================

Stage 1: Initial Canary (10% traffic)
┌──────────────────────────────────────────────────────────────────┐
│                        Nginx Load Balancer                        │
│                       (Weighted Routing)                          │
└─────┬──────────────────────────────────────────────┬─────────────┘
      │ 90%                                          │ 10%
      ▼                                              ▼
┌─────────────────┐                        ┌─────────────────┐
│  STABLE Pool    │                        │  CANARY Pool    │
│  Version: 1.0   │                        │  Version: 1.1   │
│  PHP-FPM: 8002  │                        │  PHP-FPM: 8003  │
└─────────────────┘                        └────────┬────────┘
                                                    │
                                   Monitor for 5 minutes:
                                   - Error rate < 5%
                                   - Response time p95 < 2s
                                   - No crashes

Stage 2-4: Gradual Increase (25% → 50% → 75%)
┌──────────────────────────────────────────────────────────────────┐
│                    Each stage waits 5 minutes                     │
│                    Monitoring metrics closely                     │
│                    Auto-rollback if thresholds exceeded           │
└──────────────────────────────────────────────────────────────────┘

Stage 5: Full Deployment (100% traffic)
┌──────────────────────────────────────────────────────────────────┐
│                        Nginx Load Balancer                        │
└─────────────────────────────────────┬───────────────────────────┘
                                      │ 100%
                                      ▼
                            ┌─────────────────┐
                            │  STABLE Pool    │
                            │  Version: 1.1   │
                            │  (was canary)   │
                            └─────────────────┘

Canary pool removed, deployment finalized

================================================================================
5. MONITORING & METRICS FLOW
================================================================================

┌────────────────────────────────────────────────────────────────────┐
│                     Application Server                             │
│                                                                     │
│  ┌───────────┐  ┌────────────┐  ┌────────────┐  ┌─────────────┐ │
│  │   Nginx   │  │  PHP-FPM   │  │   MySQL    │  │    Redis    │ │
│  └─────┬─────┘  └──────┬─────┘  └──────┬─────┘  └──────┬──────┘ │
│        │               │                │                │         │
│        │ metrics       │ metrics        │ metrics        │ stats   │
│        ▼               ▼                ▼                ▼         │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │             Prometheus Exporters                            │ │
│  │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐      │ │
│  │  │  Nginx   │ │   PHP    │ │  MySQL   │ │   Node   │      │ │
│  │  │ Exporter │ │ Exporter │ │ Exporter │ │ Exporter │      │ │
│  │  │  :9113   │ │  :9253   │ │  :9104   │ │  :9100   │      │ │
│  │  └─────┬────┘ └─────┬────┘ └─────┬────┘ └─────┬────┘      │ │
│  │        └─────────────┴─────────────┴────────────┘           │ │
│  └───────────────────────────────────┬────────────────────────┘ │
│                                      │                           │
│  ┌───────────────────────────────────▼────────────────────────┐ │
│  │              Grafana Alloy Agent                           │ │
│  │  - Collects all metrics                                    │ │
│  │  - Aggregates and filters                                  │ │
│  │  - Forwards to Prometheus                                  │ │
│  └───────────────────────────────────┬────────────────────────┘ │
└────────────────────────────────────────┼──────────────────────────┘
                                         │ Push metrics
                                         ▼
┌────────────────────────────────────────────────────────────────────┐
│                   Observability Server                             │
│                                                                     │
│  ┌──────────────────────────────────────────────────────────────┐ │
│  │                    Prometheus                                │ │
│  │  - Stores metrics (30 days)                                 │ │
│  │  - Evaluates alert rules                                    │ │
│  │  - Provides query API                                       │ │
│  └────────┬───────────────────────────────────┬─────────────────┘ │
│           │                                   │                   │
│           ▼                                   ▼                   │
│  ┌────────────────┐                 ┌─────────────────────────┐ │
│  │  Alertmanager  │                 │       Grafana           │ │
│  │  - Groups      │                 │  - Dashboards           │ │
│  │  - Routes      │                 │  - Visualizations       │ │
│  │  - Dedup       │                 │  - Annotations          │ │
│  └────────┬───────┘                 └─────────────────────────┘ │
│           │                                                       │
│           ▼                                                       │
│  ┌────────────────────────────────────────┐                      │
│  │        Alert Destinations              │                      │
│  │  ┌──────────┐ ┌────────┐ ┌─────────┐ │                      │
│  │  │PagerDuty │ │ Slack  │ │  Email  │ │                      │
│  │  └──────────┘ └────────┘ └─────────┘ │                      │
│  └────────────────────────────────────────┘                      │
└────────────────────────────────────────────────────────────────────┘

================================================================================
6. BACKUP & RECOVERY FLOW
================================================================================

┌────────────────────────────────────────────────────────────────────┐
│                    Backup Schedule (Automated)                     │
└────────────────────────────────────────────────────────────────────┘

Every 6 Hours:                    Daily at 02:00 UTC:
┌─────────────────┐              ┌──────────────────────┐
│ Database Backup │              │   Full Backup        │
│  - mysqldump    │              │  - Database          │
│  - Compress     │              │  - Files             │
│  - Encrypt      │              │  - Configuration     │
│  - Upload S3    │              │  - System info       │
└────────┬────────┘              └────────┬─────────────┘
         │                                │
         └────────────┬───────────────────┘
                      ▼
         ┌────────────────────────────┐
         │   Local Storage            │
         │   /var/backups/chom/       │
         │   Retention: 7 days        │
         └────────────┬───────────────┘
                      │
                      │ S3 Sync
                      ▼
         ┌────────────────────────────┐
         │   Offsite Storage (S3)     │
         │   s3://chom-backups/       │
         │   Retention: 90 days       │
         │   Archive: Glacier (30d+)  │
         └────────────────────────────┘

Recovery Process:
┌─────────────┐    ┌──────────────┐    ┌─────────────┐    ┌──────────┐
│   Incident  │ → │ Choose       │ → │  Download   │ → │  Restore │
│   Occurs    │   │ Backup Point │   │  from S3    │   │  to VPS  │
└─────────────┘    └──────────────┘    └─────────────┘    └──────────┘
                                                                 │
                                                                 ▼
                                                      ┌──────────────────┐
                                                      │  Verify & Test   │
                                                      │  - Health checks │
                                                      │  - Smoke tests   │
                                                      └──────────────────┘

================================================================================
7. DISASTER RECOVERY SCENARIOS
================================================================================

Scenario 1: Database Corruption
┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐
│ Stop App     │→│ Get Latest   │→│ Restore DB   │→│ Verify &     │
│ (Maintenance)│  │ Backup       │  │ from Backup  │  │ Start App    │
└──────────────┘  └──────────────┘  └──────────────┘  └──────────────┘
RTO: 1 hour       RPO: 6 hours (last backup)

Scenario 2: VPS Failure
┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐
│ Provision    │→│ Bootstrap    │→│ Restore All  │→│ Update DNS   │
│ New VPS      │  │ System       │  │ from Backups │  │ & Verify     │
└──────────────┘  └──────────────┘  └──────────────┘  └──────────────┘
RTO: 2-4 hours    RPO: 24 hours (daily backup)

Scenario 3: Deployment Failure
┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐
│ Detect       │→│ Automatic    │→│ Verify       │→│ Root Cause   │
│ Failure      │  │ Rollback     │  │ Health       │  │ Analysis     │
└──────────────┘  └──────────────┘  └──────────────┘  └──────────────┘
RTO: < 30 seconds RPO: 0 (instant rollback to previous version)

================================================================================
8. COMPLETE DEPLOYMENT WORKFLOW
================================================================================

Developer                    CI/CD                Production           Monitoring
    │                          │                      │                    │
    │ 1. Git Push             │                      │                    │
    ├────────────────────────►│                      │                    │
    │                          │                      │                    │
    │                          │ 2. Build & Test     │                    │
    │                          ├──────────┐          │                    │
    │                          │          │          │                    │
    │                          │◄─────────┘          │                    │
    │                          │                      │                    │
    │                          │ 3. Security Scan    │                    │
    │                          ├──────────┐          │                    │
    │                          │          │          │                    │
    │                          │◄─────────┘          │                    │
    │                          │                      │                    │
    │                          │ 4. Deploy Artifact  │                    │
    │                          ├─────────────────────►│                    │
    │                          │                      │ 5. Backup DB       │
    │                          │                      ├────────┐           │
    │                          │                      │        │           │
    │                          │                      │◄───────┘           │
    │                          │                      │                    │
    │                          │                      │ 6. Deploy GREEN    │
    │                          │                      ├────────┐           │
    │                          │                      │        │           │
    │                          │                      │◄───────┘           │
    │                          │                      │                    │
    │                          │                      │ 7. Health Check    │
    │                          │                      ├────────┐           │
    │                          │                      │        │           │
    │                          │                      │◄───────┘           │
    │                          │                      │                    │
    │                          │                      │ 8. ATOMIC SWITCH   │
    │                          │                      ├────────┐           │
    │                          │                      │        │           │
    │                          │                      │◄───────┘           │
    │                          │                      │                    │
    │                          │ 9. Verify Success   │                    │
    │                          │◄─────────────────────┤                    │
    │                          │                      │                    │
    │                          │ 10. Add Annotation  │                    │
    │                          ├─────────────────────────────────────────►│
    │                          │                      │                    │
    │ 11. Slack Notification  │                      │                    │
    │◄─────────────────────────┤                      │                    │
    │                          │                      │                    │
    │                          │                      │ 12. Monitor        │
    │                          │                      │◄───────────────────┤
    │                          │                      │                    │

Duration: ~12-15 minutes
Downtime: 0 seconds
Rollback: < 30 seconds if needed

================================================================================
END OF ARCHITECTURE DIAGRAMS
================================================================================
