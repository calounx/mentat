; =============================================================================
; CHOM Production PHP-FPM Configuration
; Optimized for Laravel Application Performance
; =============================================================================
; Version: 1.0.0
; Last Updated: 2026-01-02
; =============================================================================

[global]
; Process management
pid = /run/php/php-fpm.pid
error_log = /var/log/php-fpm/error.log
log_level = notice

; Emergency restart threshold
emergency_restart_threshold = 10
emergency_restart_interval = 1m
process_control_timeout = 10s

; System limits
rlimit_files = 65535
rlimit_core = 0

; =============================================================================
; CHOM Application Pool
; =============================================================================
[chom]

; Pool Configuration
user = www-data
group = www-data
listen = /var/run/php/php-fpm.sock
listen.owner = www-data
listen.group = www-data
listen.mode = 0660
listen.backlog = 511

; -----------------------------------------------------------------------------
; Process Management (Critical for Performance)
; -----------------------------------------------------------------------------
; Dynamic process management for optimal resource utilization
pm = dynamic

; Start with moderate process count
pm.max_children = 50        ; Maximum number of child processes
pm.start_servers = 10       ; Initial number of servers to start
pm.min_spare_servers = 5    ; Minimum idle servers
pm.max_spare_servers = 15   ; Maximum idle servers

; Request limits (prevent memory leaks)
pm.max_requests = 1000      ; Restart worker after N requests

; Process idle timeout
pm.process_idle_timeout = 10s

; Status monitoring
pm.status_path = /php-fpm/status
pm.status_listen = 127.0.0.1:9001

; Ping monitoring
ping.path = /php-fpm/ping
ping.response = pong

; -----------------------------------------------------------------------------
; Performance Tuning
; -----------------------------------------------------------------------------
; Request timeouts
request_terminate_timeout = 60s
request_slowlog_timeout = 10s

; Slow log for performance monitoring
slowlog = /var/log/php-fpm/slow.log

; -----------------------------------------------------------------------------
; Resource Limits
; -----------------------------------------------------------------------------
; Memory limit per request (should match php.ini)
php_admin_value[memory_limit] = 256M

; Upload limits
php_admin_value[upload_max_filesize] = 100M
php_admin_value[post_max_size] = 100M

; Execution time
php_admin_value[max_execution_time] = 60
php_admin_value[max_input_time] = 60

; -----------------------------------------------------------------------------
; Error Handling & Logging
; -----------------------------------------------------------------------------
; Error logging
php_admin_flag[log_errors] = on
php_admin_value[error_log] = /var/log/php-fpm/chom-error.log

; Display errors (CRITICAL: disabled in production)
php_flag[display_errors] = off
php_admin_value[display_errors] = off
php_admin_flag[display_startup_errors] = off

; Error reporting level
php_admin_value[error_reporting] = E_ALL & ~E_DEPRECATED & ~E_STRICT

; -----------------------------------------------------------------------------
; OPcache Settings (Critical for Laravel Performance)
; -----------------------------------------------------------------------------
php_admin_value[opcache.enable] = 1
php_admin_value[opcache.enable_cli] = 1
php_admin_value[opcache.memory_consumption] = 256
php_admin_value[opcache.interned_strings_buffer] = 16
php_admin_value[opcache.max_accelerated_files] = 20000

; IMPORTANT: Disable file validation in production for maximum performance
php_admin_value[opcache.validate_timestamps] = 0
php_admin_value[opcache.revalidate_freq] = 0

; Optimization settings
php_admin_value[opcache.fast_shutdown] = 1
php_admin_value[opcache.enable_file_override] = 1

; JIT Compilation (PHP 8.0+)
php_admin_value[opcache.jit] = 1255
php_admin_value[opcache.jit_buffer_size] = 128M

; -----------------------------------------------------------------------------
; Session Configuration
; -----------------------------------------------------------------------------
; Use Redis for session storage (configured in Laravel)
php_value[session.save_handler] = redis
php_value[session.save_path] = "tcp://127.0.0.1:6379?database=3"
php_value[session.gc_maxlifetime] = 7200

; Session security
php_flag[session.cookie_httponly] = on
php_flag[session.cookie_secure] = on
php_value[session.cookie_samesite] = Strict

; -----------------------------------------------------------------------------
; Realpath Cache (Important for Laravel Performance)
; -----------------------------------------------------------------------------
; Increase realpath cache for better file system performance
php_admin_value[realpath_cache_size] = 4096k
php_admin_value[realpath_cache_ttl] = 600

; -----------------------------------------------------------------------------
; Additional Security Settings
; -----------------------------------------------------------------------------
; Disable dangerous functions
php_admin_value[disable_functions] = exec,passthru,shell_exec,system,proc_open,popen,curl_exec,curl_multi_exec,parse_ini_file,show_source

; Expose PHP version (disable for security)
php_admin_flag[expose_php] = off

; File uploads security
php_admin_value[file_uploads] = 1
php_admin_value[upload_tmp_dir] = /tmp

; -----------------------------------------------------------------------------
; Environment Variables
; -----------------------------------------------------------------------------
; Pass environment variables to PHP
env[HOSTNAME] = $HOSTNAME
env[PATH] = /usr/local/bin:/usr/bin:/bin
env[TMP] = /tmp
env[TMPDIR] = /tmp
env[TEMP] = /tmp

; -----------------------------------------------------------------------------
; Monitoring & Health Checks
; -----------------------------------------------------------------------------
; Access log for request monitoring
access.log = /var/log/php-fpm/access.log
access.format = "%R - %u %t \"%m %r%Q%q\" %s %f %{mili}d %{kilo}M %C%%"

; Clear environment variables for security
clear_env = no

; =============================================================================
; PERFORMANCE OPTIMIZATION NOTES
; =============================================================================
; 1. Adjust pm.max_children based on available RAM:
;    Formula: pm.max_children = (Available RAM) / (Average PHP Process Size)
;    Example: 4GB RAM / 80MB per process = ~50 max children
;
; 2. Monitor with: watch -n 1 'ps aux | grep php-fpm'
;
; 3. Check status: curl http://localhost/php-fpm/status
;
; 4. Reload config: systemctl reload php8.2-fpm
;
; 5. After code deployment, reload to clear OPcache:
;    systemctl reload php8.2-fpm
;
; 6. For high-traffic sites, consider using 'ondemand' pm mode:
;    pm = ondemand
;    pm.max_children = 100
;    pm.process_idle_timeout = 10s
; =============================================================================
