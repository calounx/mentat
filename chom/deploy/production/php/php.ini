; =============================================================================
; CHOM Production PHP Configuration (php.ini)
; Optimized for Laravel 11 Application Performance
; =============================================================================
; PHP Version: 8.2+
; Last Updated: 2026-01-02
; =============================================================================

[PHP]

; =============================================================================
; PERFORMANCE & RESOURCE LIMITS
; =============================================================================

; Maximum execution time (seconds)
max_execution_time = 60

; Maximum input parsing time (seconds)
max_input_time = 60

; Maximum memory limit per script
memory_limit = 256M

; Maximum POST data size
post_max_size = 100M

; Maximum upload file size
upload_max_filesize = 100M

; Maximum number of input variables
max_input_vars = 5000
max_input_nesting_level = 64

; =============================================================================
; ERROR HANDLING & LOGGING
; =============================================================================

; CRITICAL: Disable error display in production
display_errors = Off
display_startup_errors = Off

; Log errors to file instead
log_errors = On
error_log = /var/log/php/error.log

; Error reporting level (log everything except deprecated warnings)
error_reporting = E_ALL & ~E_DEPRECATED & ~E_STRICT

; Log repeated errors
ignore_repeated_errors = Off
ignore_repeated_source = Off

; =============================================================================
; OPCACHE CONFIGURATION (Critical for Performance)
; =============================================================================

[opcache]
; Enable OPcache (CRITICAL)
opcache.enable = 1
opcache.enable_cli = 1

; Memory allocation
opcache.memory_consumption = 256
opcache.interned_strings_buffer = 16

; Maximum number of files to cache
opcache.max_accelerated_files = 20000

; CRITICAL: Disable file validation checks in production
opcache.validate_timestamps = 0
opcache.revalidate_freq = 0

; Optimization features
opcache.fast_shutdown = 1
opcache.enable_file_override = 1

; File cache for improved performance
opcache.file_cache = /var/tmp/opcache
opcache.file_cache_only = 0
opcache.file_cache_consistency_checks = 0

; JIT Compilation (PHP 8.0+)
opcache.jit = 1255
opcache.jit_buffer_size = 128M

; Preload (Laravel optimization)
; opcache.preload = /var/www/chom/opcache-preload.php
; opcache.preload_user = www-data

; =============================================================================
; REALPATH CACHE (Important for Laravel)
; =============================================================================

; Increase realpath cache for better file system performance
realpath_cache_size = 4096k
realpath_cache_ttl = 600

; =============================================================================
; SESSION CONFIGURATION
; =============================================================================

; Use Redis for sessions (configured via Laravel)
session.save_handler = files
session.save_path = "/var/lib/php/sessions"

; Session lifetime
session.gc_maxlifetime = 7200
session.gc_probability = 1
session.gc_divisor = 100

; Session security settings
session.use_strict_mode = 1
session.use_cookies = 1
session.use_only_cookies = 1
session.cookie_httponly = 1
session.cookie_secure = 1
session.cookie_samesite = Strict
session.name = CHOM_SESSION

; Session ID settings
session.sid_length = 48
session.sid_bits_per_character = 6

; =============================================================================
; SECURITY SETTINGS
; =============================================================================

; Disable dangerous functions
disable_functions = exec,passthru,shell_exec,system,proc_open,popen,curl_exec,curl_multi_exec,parse_ini_file,show_source

; Disable expose_php header
expose_php = Off

; Open basedir restriction (uncomment and customize for production)
; open_basedir = /var/www/chom:/tmp:/var/tmp:/usr/share/php

; File uploads
file_uploads = On
upload_tmp_dir = /tmp
max_file_uploads = 20

; SQL safe mode
sql.safe_mode = Off

; =============================================================================
; DATE & TIME
; =============================================================================

[Date]
date.timezone = UTC

; =============================================================================
; MAIL CONFIGURATION
; =============================================================================

[mail function]
; For Linux
sendmail_path = /usr/sbin/sendmail -t -i
mail.add_x_header = Off

; =============================================================================
; MYSQLI EXTENSION
; =============================================================================

[mysqli]
mysqli.max_persistent = -1
mysqli.allow_persistent = On
mysqli.max_links = -1
mysqli.default_port = 3306
mysqli.default_socket =
mysqli.default_host =
mysqli.default_user =
mysqli.default_pw =
mysqli.reconnect = Off
mysqli.allow_local_infile = Off

; =============================================================================
; MYSQLND (MySQL Native Driver)
; =============================================================================

[mysqlnd]
mysqlnd.collect_statistics = On
mysqlnd.collect_memory_statistics = On

; =============================================================================
; PDO MYSQL
; =============================================================================

[Pdo_mysql]
pdo_mysql.default_socket=
pdo_mysql.debug = Off

; =============================================================================
; REDIS EXTENSION
; =============================================================================

[redis]
; Redis session handler (if using Redis for sessions)
redis.session.locking_enabled = 1
redis.session.lock_expire = 60
redis.session.lock_wait_time = 50000

; =============================================================================
; ADDITIONAL PHP EXTENSIONS
; =============================================================================

[bcmath]
bcmath.scale = 0

[gd]
; No specific configuration needed

[curl]
; curl.cainfo = /path/to/ca-bundle.crt

[openssl]
; openssl.cafile = /path/to/ca-bundle.crt
; openssl.capath = /path/to/certs

; =============================================================================
; ASSERTIONS (Disable in production)
; =============================================================================

[Assertion]
zend.assertions = -1
assert.active = Off

; =============================================================================
; MISCELLANEOUS SETTINGS
; =============================================================================

; Short open tags (not recommended, but may be needed for legacy code)
short_open_tag = Off

; Output buffering
output_buffering = 4096

; Implicit flush
implicit_flush = Off

; Serialize precision
serialize_precision = -1

; Default charset
default_charset = "UTF-8"

; =============================================================================
; OPTIMIZATION NOTES
; =============================================================================
; 1. After updating this file, restart PHP-FPM:
;    systemctl restart php8.2-fpm
;
; 2. Verify settings:
;    php -i | grep opcache
;    php -i | grep memory_limit
;
; 3. Monitor OPcache usage:
;    - Install: composer require amnuts/opcache-gui
;    - Or use: php -r "print_r(opcache_get_status());"
;
; 4. For maximum performance, consider:
;    - Enabling opcache.preload for Laravel
;    - Using PHP 8.2+ for JIT compilation
;    - Monitoring memory_limit usage and adjusting
;
; 5. After code deployment:
;    - Clear OPcache: systemctl reload php8.2-fpm
;    - Or: php artisan opcache:clear
; =============================================================================
