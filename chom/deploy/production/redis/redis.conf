# =============================================================================
# CHOM Production Redis Configuration
# Optimized for Laravel Cache, Session, and Queue Storage
# =============================================================================
# Redis Version: 7.0+
# Last Updated: 2026-01-02
# =============================================================================

# =============================================================================
# NETWORK CONFIGURATION
# =============================================================================

# Bind to all interfaces (use 127.0.0.1 for local-only)
bind 0.0.0.0 ::1

# Protected mode (disable if using password authentication)
protected-mode yes

# Port
port 6379

# TCP backlog (max number of pending connections)
tcp-backlog 511

# Timeout for idle clients (0 = disabled)
timeout 300

# TCP keepalive (recommended: 60 seconds)
tcp-keepalive 60

# =============================================================================
# GENERAL CONFIGURATION
# =============================================================================

# Run as daemon
daemonize no
supervised systemd

# PID file
pidfile /var/run/redis/redis-server.pid

# Log level: debug, verbose, notice, warning
loglevel notice

# Log file
logfile /var/log/redis/redis-server.log

# Number of databases
databases 16

# Show Redis logo on startup
always-show-logo no

# =============================================================================
# SECURITY
# =============================================================================

# CRITICAL: Set a strong password for production
# requirepass your_strong_password_here

# Rename dangerous commands (optional, for extra security)
# rename-command FLUSHDB ""
# rename-command FLUSHALL ""
# rename-command CONFIG ""
# rename-command SHUTDOWN ""
# rename-command KEYS ""

# ACL (Access Control Lists) for Redis 6.0+
# aclfile /etc/redis/users.acl

# =============================================================================
# MEMORY MANAGEMENT (Critical for Performance)
# =============================================================================

# Maximum memory allocation (CRITICAL: Set based on available RAM)
# For 8GB server: 2-3GB for Redis
# For 16GB server: 4-6GB for Redis
maxmemory 2gb

# Eviction policy when max memory is reached
# Options: noeviction, allkeys-lru, allkeys-lfu, volatile-lru, volatile-lfu,
#          allkeys-random, volatile-random, volatile-ttl
maxmemory-policy allkeys-lru

# Samples for LRU/LFU algorithms (higher = more accurate, slower)
maxmemory-samples 5

# Memory usage tracking
maxmemory-eviction-tenacity 10

# =============================================================================
# PERSISTENCE CONFIGURATION
# =============================================================================

# OPTION 1: No persistence (pure cache) - Fastest, data loss on restart
# For pure cache/session storage, disable both RDB and AOF
save ""
appendonly no

# OPTION 2: RDB Snapshots (moderate persistence, faster than AOF)
# Uncomment for snapshot-based persistence
# save 900 1      # Save if 1 key changed in 900 seconds
# save 300 10     # Save if 10 keys changed in 300 seconds
# save 60 10000   # Save if 10000 keys changed in 60 seconds
# stop-writes-on-bgsave-error yes
# rdbcompression yes
# rdbchecksum yes
# dbfilename dump.rdb
# dir /var/lib/redis

# OPTION 3: AOF (Append Only File) - Best persistence, slower
# Uncomment for maximum data durability
# appendonly yes
# appendfilename "appendonly.aof"
# appendfsync everysec  # Options: always, everysec, no
# no-appendfsync-on-rewrite no
# auto-aof-rewrite-percentage 100
# auto-aof-rewrite-min-size 64mb
# aof-load-truncated yes
# aof-use-rdb-preamble yes
# dir /var/lib/redis

# =============================================================================
# REPLICATION (if using Redis replicas)
# =============================================================================

# Replica configuration
# replicaof <masterip> <masterport>
# masterauth <master-password>

# Replica settings
# replica-serve-stale-data yes
# replica-read-only yes
# repl-diskless-sync no
# repl-diskless-sync-delay 5
# repl-ping-replica-period 10
# repl-timeout 60
# repl-disable-tcp-nodelay no
# repl-backlog-size 1mb
# repl-backlog-ttl 3600

# =============================================================================
# PERFORMANCE OPTIMIZATION
# =============================================================================

# Slow log (log queries slower than specified microseconds)
slowlog-log-slower-than 10000
slowlog-max-len 128

# Latency monitoring
latency-monitor-threshold 100

# HyperLogLog precision
hll-sparse-max-bytes 3000

# Active rehashing
activerehashing yes

# Client output buffer limits
# client-output-buffer-limit normal 0 0 0
# client-output-buffer-limit replica 256mb 64mb 60
# client-output-buffer-limit pubsub 32mb 8mb 60

# Frequency of rehashing (1-100, higher = more CPU, faster rehashing)
hz 10

# Dynamic HZ (adaptive)
dynamic-hz yes

# AOF rewrite buffer
# aof-rewrite-incremental-fsync yes

# RDB save fsync
# rdb-save-incremental-fsync yes

# =============================================================================
# THREADED I/O (Redis 6.0+)
# =============================================================================

# I/O threads (use number of CPU cores minus 1, max 8)
# io-threads 4
# io-threads-do-reads yes

# =============================================================================
# ADVANCED CONFIGURATION
# =============================================================================

# Hash settings
hash-max-ziplist-entries 512
hash-max-ziplist-value 64

# List settings
list-max-ziplist-size -2
list-compress-depth 0

# Set settings
set-max-intset-entries 512

# Sorted set settings
zset-max-ziplist-entries 128
zset-max-ziplist-value 64

# Stream settings
stream-node-max-bytes 4096
stream-node-max-entries 100

# Lua scripting timeout (milliseconds)
lua-time-limit 5000

# Notify keyspace events (disabled by default for performance)
# notify-keyspace-events ""

# =============================================================================
# LARAVEL-SPECIFIC OPTIMIZATIONS
# =============================================================================

# Database allocation for Laravel:
# - Database 0: Default (general cache)
# - Database 1: Cache (Laravel CACHE_STORE=redis)
# - Database 2: Queue (Laravel QUEUE_CONNECTION=redis)
# - Database 3: Session (Laravel SESSION_DRIVER=redis)
# - Database 4-15: Available for custom use

# =============================================================================
# MONITORING & DEBUGGING
# =============================================================================

# Enable commands stats
# latency-tracking yes
# latency-tracking-info-percentiles 50 99 99.9

# Track memory statistics
# tracking-table-max-keys 1000000

# =============================================================================
# MODULE LOADING (if using Redis modules)
# =============================================================================

# Load modules on startup
# loadmodule /path/to/redis/module.so
# loadmodule /path/to/other_module.so

# =============================================================================
# CLUSTER MODE (if using Redis Cluster)
# =============================================================================

# cluster-enabled yes
# cluster-config-file nodes-6379.conf
# cluster-node-timeout 15000
# cluster-replica-validity-factor 10
# cluster-migration-barrier 1
# cluster-require-full-coverage yes
# cluster-replica-no-failover no

# =============================================================================
# OPTIMIZATION NOTES
# =============================================================================
# 1. After changing configuration, restart Redis:
#    systemctl restart redis-server
#
# 2. Verify settings:
#    redis-cli CONFIG GET maxmemory
#    redis-cli INFO memory
#
# 3. Monitor performance:
#    redis-cli INFO stats
#    redis-cli SLOWLOG GET 10
#    redis-cli --latency
#    redis-cli --latency-history
#
# 4. Monitor memory usage:
#    redis-cli INFO memory | grep used_memory
#    redis-cli MEMORY STATS
#
# 5. For Laravel cache optimization:
#    - Use Redis for session storage (fastest)
#    - Use separate databases for cache/queue/session
#    - Monitor hit rate: redis-cli INFO stats | grep keyspace
#
# 6. Performance tuning:
#    - Disable persistence for pure cache (save "")
#    - Use allkeys-lru eviction for cache workloads
#    - Enable io-threads for high concurrency
#    - Monitor with redis-cli --stat
#
# 7. Security best practices:
#    - Set requirepass for production
#    - Use bind 127.0.0.1 if Redis is local-only
#    - Rename dangerous commands
#    - Use ACL for multi-tenant access
#
# 8. Backup recommendations:
#    - For cache-only: No backups needed
#    - For session storage: Use RDB snapshots
#    - For queue data: Use AOF with appendfsync everysec
# =============================================================================
