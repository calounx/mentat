#!/bin/bash
# Pre-commit hook: Run code quality checks before allowing commit
set -e

echo "üîç Running pre-commit checks..."
echo ""

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Get list of staged PHP files
STAGED_PHP_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.php$' || true)

if [ -z "$STAGED_PHP_FILES" ]; then
    echo -e "${GREEN}‚úì No PHP files to check${NC}"
    exit 0
fi

echo -e "${YELLOW}Checking $(echo "$STAGED_PHP_FILES" | wc -l) PHP file(s)...${NC}"
echo ""

# Run PHP Linter (syntax check)
echo "1Ô∏è‚É£  PHP Syntax Check..."
for FILE in $STAGED_PHP_FILES; do
    php -l "$FILE" > /dev/null 2>&1
    if [ $? -ne 0 ]; then
        echo -e "${RED}‚úó PHP syntax error in $FILE${NC}"
        php -l "$FILE"
        exit 1
    fi
done
echo -e "${GREEN}‚úì PHP syntax check passed${NC}"
echo ""

# Run Laravel Pint (code formatting)
echo "2Ô∏è‚É£  Laravel Pint (Code Formatting)..."
if [ -x vendor/bin/pint ]; then
    vendor/bin/pint --test $STAGED_PHP_FILES
    if [ $? -ne 0 ]; then
        echo -e "${YELLOW}‚ö† Code style issues found. Auto-fixing...${NC}"
        vendor/bin/pint $STAGED_PHP_FILES
        # Re-add fixed files
        git add $STAGED_PHP_FILES
        echo -e "${GREEN}‚úì Code style fixed and re-staged${NC}"
    else
        echo -e "${GREEN}‚úì Code style check passed${NC}"
    fi
else
    echo -e "${YELLOW}‚ö† Laravel Pint not installed, skipping...${NC}"
fi
echo ""

# Run PHPStan (static analysis) - Only on changed files
echo "3Ô∏è‚É£  PHPStan (Static Analysis)..."
if [ -x vendor/bin/phpstan ]; then
    vendor/bin/phpstan analyse --no-progress $STAGED_PHP_FILES
    if [ $? -ne 0 ]; then
        echo -e "${RED}‚úó PHPStan found issues${NC}"
        echo -e "${YELLOW}Tip: Fix the issues or use --no-verify to skip checks${NC}"
        exit 1
    fi
    echo -e "${GREEN}‚úì Static analysis passed${NC}"
else
    echo -e "${YELLOW}‚ö† PHPStan not installed, skipping...${NC}"
fi
echo ""

# Run tests if test files changed
STAGED_TEST_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E 'tests/.*\.php$' || true)

if [ -n "$STAGED_TEST_FILES" ]; then
    echo "4Ô∏è‚É£  Running Tests..."
    php artisan test --stop-on-failure --compact
    if [ $? -ne 0 ]; then
        echo -e "${RED}‚úó Tests failed${NC}"
        echo -e "${YELLOW}Tip: Fix the tests or use --no-verify to skip checks${NC}"
        exit 1
    fi
    echo -e "${GREEN}‚úì Tests passed${NC}"
    echo ""
fi

echo -e "${GREEN}========================================${NC}"
echo -e "${GREEN}‚úì All pre-commit checks passed!${NC}"
echo -e "${GREEN}========================================${NC}"
echo ""

exit 0
