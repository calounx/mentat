#!/bin/bash
# Pre-push hook: Run full test suite before pushing
set -e

echo "ðŸš€ Running pre-push checks..."
echo ""

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Get the branch being pushed
current_branch=$(git symbolic-ref HEAD | sed -e 's,.*/\(.*\),\1,')

echo -e "${YELLOW}Branch: $current_branch${NC}"
echo ""

# Run full test suite
echo "1ï¸âƒ£  Running Full Test Suite..."
php artisan test --stop-on-failure
if [ $? -ne 0 ]; then
    echo -e "${RED}âœ— Tests failed${NC}"
    echo -e "${YELLOW}Tip: Fix the tests or use --no-verify to skip checks${NC}"
    exit 1
fi
echo -e "${GREEN}âœ“ All tests passed${NC}"
echo ""

# Check for uncommitted changes
echo "2ï¸âƒ£  Checking for Uncommitted Changes..."
if ! git diff-index --quiet HEAD --; then
    echo -e "${YELLOW}âš  You have uncommitted changes${NC}"
    git status --short
    echo ""
    echo -e "${YELLOW}Consider committing or stashing these changes${NC}"
    # Don't block push, just warn
fi
echo ""

# Check if pushing to protected branches
if [ "$current_branch" == "main" ] || [ "$current_branch" == "master" ]; then
    echo -e "${YELLOW}âš  WARNING: You are pushing to $current_branch${NC}"
    echo -e "${YELLOW}Consider using a feature branch and creating a PR${NC}"
    echo ""

    read -p "Are you sure you want to push to $current_branch? (y/N) " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo -e "${RED}âœ— Push cancelled${NC}"
        exit 1
    fi
fi

# Check for debug statements
echo "3ï¸âƒ£  Checking for Debug Statements..."
DEBUG_STATEMENTS=$(git diff origin/$current_branch --name-only | xargs grep -n -E "(dd\(|dump\(|var_dump\(|print_r\()" -- 2>/dev/null || true)

if [ -n "$DEBUG_STATEMENTS" ]; then
    echo -e "${YELLOW}âš  Found potential debug statements:${NC}"
    echo "$DEBUG_STATEMENTS"
    echo ""
    echo -e "${YELLOW}Consider removing debug statements before pushing${NC}"
    # Don't block push, just warn
fi
echo ""

# Check for TODOs
echo "4ï¸âƒ£  Checking for TODOs..."
TODO_COUNT=$(git diff origin/$current_branch --name-only | xargs grep -n -E "(TODO|FIXME|XXX)" -- 2>/dev/null | wc -l || true)

if [ "$TODO_COUNT" -gt 0 ]; then
    echo -e "${YELLOW}âš  Found $TODO_COUNT TODO/FIXME comment(s)${NC}"
    echo -e "${YELLOW}Consider addressing them or creating issues${NC}"
    # Don't block push, just warn
fi
echo ""

echo -e "${GREEN}========================================${NC}"
echo -e "${GREEN}âœ“ All pre-push checks passed!${NC}"
echo -e "${GREEN}========================================${NC}"
echo ""

exit 0
