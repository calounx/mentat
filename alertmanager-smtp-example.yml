# Example SMTP Configuration for Alertmanager
# This is a ready-to-use example with SendGrid
# Replace the values with your actual SMTP credentials

# =============================================================================
# EXAMPLE 1: SendGrid (RECOMMENDED FOR PRODUCTION)
# =============================================================================

global:
  resolve_timeout: 5m

  # SMTP Configuration - SendGrid
  smtp_from: 'alerts@arewel.com'                    # Your from address
  smtp_smarthost: 'smtp.sendgrid.net:587'           # SendGrid SMTP server
  smtp_auth_username: 'apikey'                      # Always 'apikey' for SendGrid
  smtp_auth_password: 'SG.xxxxxxxxxxxxxxxxxxxxx'   # Your SendGrid API key
  smtp_require_tls: true                            # Always true for SendGrid

route:
  group_by: ['alertname', 'cluster', 'service']
  group_wait: 10s
  group_interval: 10s
  repeat_interval: 12h
  receiver: 'default'

  routes:
    - match:
        severity: critical
      receiver: 'critical-alerts'
      continue: true
      repeat_interval: 4h

    - match:
        severity: warning
      receiver: 'warning-alerts'
      repeat_interval: 12h

inhibit_rules:
  - source_match:
      severity: 'critical'
    target_match:
      severity: 'warning'
    equal: ['alertname', 'instance']

  - source_match:
      alertname: 'InstanceDown'
    target_match_re:
      severity: '.*'
    equal: ['instance']

receivers:
  - name: 'default'

  - name: 'critical-alerts'
    email_configs:
      - to: 'ops@arewel.com'                       # Your ops email
        headers:
          Subject: '[CRITICAL] {{ .GroupLabels.alertname }} on {{ .GroupLabels.instance }}'
        html: |
          <h2 style="color: #dc2626;">üö® Critical Alert</h2>
          <p><strong>Alert:</strong> {{ .GroupLabels.alertname }}</p>
          <p><strong>Instance:</strong> {{ .GroupLabels.instance }}</p>
          <p><strong>Severity:</strong> {{ .GroupLabels.severity }}</p>
          {{ range .Alerts }}
          <hr>
          <p><strong>Description:</strong> {{ .Annotations.description }}</p>
          <p><strong>Summary:</strong> {{ .Annotations.summary }}</p>
          <p><strong>Started:</strong> {{ .StartsAt.Format "2006-01-02 15:04:05" }}</p>
          {{ end }}
        send_resolved: true

  - name: 'warning-alerts'
    email_configs:
      - to: 'ops@arewel.com'                       # Your ops email
        headers:
          Subject: '[WARNING] {{ .GroupLabels.alertname }} on {{ .GroupLabels.instance }}'
        html: |
          <h2 style="color: #f59e0b;">‚ö†Ô∏è Warning Alert</h2>
          <p><strong>Alert:</strong> {{ .GroupLabels.alertname }}</p>
          <p><strong>Instance:</strong> {{ .GroupLabels.instance }}</p>
          <p><strong>Severity:</strong> {{ .GroupLabels.severity }}</p>
          {{ range .Alerts }}
          <hr>
          <p><strong>Description:</strong> {{ .Annotations.description }}</p>
          <p><strong>Summary:</strong> {{ .Annotations.summary }}</p>
          <p><strong>Started:</strong> {{ .StartsAt.Format "2006-01-02 15:04:05" }}</p>
          {{ end }}
        send_resolved: true

# =============================================================================
# EXAMPLE 2: Gmail (FOR TESTING ONLY - NOT PRODUCTION)
# =============================================================================
#
# global:
#   resolve_timeout: 5m
#   smtp_from: 'your-email@gmail.com'
#   smtp_smarthost: 'smtp.gmail.com:587'
#   smtp_auth_username: 'your-email@gmail.com'
#   smtp_auth_password: 'your-app-specific-password'  # NOT your Gmail password!
#   smtp_require_tls: true
#
# IMPORTANT:
# 1. Enable 2FA in Google Account
# 2. Create app-specific password: https://myaccount.google.com/apppasswords
# 3. Use app password, not your regular Gmail password

# =============================================================================
# EXAMPLE 3: AWS SES
# =============================================================================
#
# global:
#   resolve_timeout: 5m
#   smtp_from: 'alerts@yourdomain.com'
#   smtp_smarthost: 'email-smtp.us-east-1.amazonaws.com:587'
#   smtp_auth_username: 'AKIA...'                    # Your SES SMTP username
#   smtp_auth_password: 'your-ses-smtp-password'     # Your SES SMTP password
#   smtp_require_tls: true

# =============================================================================
# EXAMPLE 4: Mailgun
# =============================================================================
#
# global:
#   resolve_timeout: 5m
#   smtp_from: 'alerts@yourdomain.com'
#   smtp_smarthost: 'smtp.mailgun.org:587'
#   smtp_auth_username: 'postmaster@yourdomain.com'
#   smtp_auth_password: 'your-mailgun-password'
#   smtp_require_tls: true

# =============================================================================
# EXAMPLE 5: No SMTP (Webhook Only)
# =============================================================================
#
# If you only want webhook notifications (no email):
#
# global:
#   resolve_timeout: 5m
#
# receivers:
#   - name: 'critical-alerts'
#     webhook_configs:
#       - url: 'http://localhost:5001/webhook/critical'
#         send_resolved: true

# =============================================================================
# DEPLOYMENT INSTRUCTIONS
# =============================================================================
#
# 1. Copy this file to mentat.arewel.com:
#    scp alertmanager-smtp-example.yml stilgar@mentat.arewel.com:/tmp/
#
# 2. SSH to mentat:
#    ssh stilgar@mentat.arewel.com
#
# 3. Edit with your SMTP credentials:
#    nano /tmp/alertmanager-smtp-example.yml
#
# 4. Backup current config:
#    sudo cp /etc/observability/alertmanager/alertmanager.yml \
#            /etc/observability/alertmanager/alertmanager.yml.backup
#
# 5. Replace with new config:
#    sudo cp /tmp/alertmanager-smtp-example.yml \
#            /etc/observability/alertmanager/alertmanager.yml
#
# 6. Fix permissions:
#    sudo chown observability:observability \
#         /etc/observability/alertmanager/alertmanager.yml
#
# 7. Validate:
#    sudo /opt/observability/bin/amtool check-config \
#         /etc/observability/alertmanager/alertmanager.yml
#
# 8. Reload:
#    sudo systemctl reload alertmanager
#
# 9. Test:
#    curl -X POST http://localhost:9093/api/v2/alerts \
#      -H "Content-Type: application/json" \
#      -d '[{
#        "labels": {"alertname": "Test", "severity": "critical"},
#        "annotations": {"summary": "Test alert"}
#      }]'
#
# 10. Check email inbox!

# =============================================================================
# CREDENTIALS NEEDED
# =============================================================================
#
# To complete this configuration, you need:
#
# 1. SMTP Host (e.g., smtp.sendgrid.net, smtp.gmail.com)
# 2. SMTP Port (usually 587 for TLS)
# 3. SMTP Username
# 4. SMTP Password or API Key
# 5. From Email Address (sender)
# 6. To Email Address (recipient - where alerts go)
#
# For SendGrid:
# - Sign up at https://sendgrid.com
# - Create API key (Settings > API Keys)
# - Verify sender email (Settings > Sender Authentication)
#
# For Gmail:
# - Enable 2FA in Google Account
# - Create app-specific password
# - Use app password, not regular password
#
# For AWS SES:
# - Create SMTP credentials in SES console
# - Verify sender email address
# - Move out of sandbox if sending to unverified recipients
